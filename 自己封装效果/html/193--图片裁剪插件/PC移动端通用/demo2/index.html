<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="twitter:card" content="summary" />
  <meta property="og:type" content="website" />
  <meta name="twitter:title" property="og:title" content="卓越云-自定义名片" />
  <meta name="twitter:description" property="og:description" content="卓越云实用小工具，更好的辅助您的业务开展。" />
  <meta name="twitter:image" property="og:image" content="http://api.summitdigitalcloud.com/calc/images/logo512.jpg" />
  <meta name="referrer" content="no-referrer"/>
  <link href="https://cdn.bootcss.com/cropper/3.0.0/cropper.css" rel="stylesheet">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/style.css">
  <title>自定义名片</title>
  <style>
    html{width: 100%; height: 100%;}
    body{width: 100%; height: 100%;}
    .eweima{float: right; width: 40px; height: 40px; position: absolute; right:10px; top:6px;}
    .eweima img{ display: block; width: 100%; height: 100%;}
    #clipArea{width: 100%; height: 100%; display: none; position: fixed; left:0; top:0; z-index: 10; background: rgba(0,0,0,0.8); }
    #clipArea img{ width: auto; height: auto; }
    #clipBtn{width: 100px; padding:10px 0; text-align:center; background: none; font-size: 16px; color: #fff; display: none; position: fixed; right:0; top:0; z-index: 11; }
    .cropper-bg{background: #000 !important;}
  </style>
</head>
<body ontouchstart="">
<!--loading -->
<div id="loading_wrap_box">
  <div id="loading_wrap">
    <div class="loading_center"></div>
  </div>
</div>
<!--loading end-->
<div class="customizeCard">
  <!--名片-->
  <div class="customizeCardDemo" id="view">
    <div class="cover"><img src="" alt=""></div>
    <div class="date">
      <p class="year">2020年04月</p>
      <p class="day">21</p>
      <p class="month">三月廿九</p>
      <!--二十的简写是“廿” 三十的简写是“卅”-->
    </div>
    <div class="slogan">
      <!--<p>我们都有一个家，名字叫中国我们</p><p>都有一个家，名字叫中国我们都有</p><p>一个家，名字叫中国我们都有一个</p><p>家，名字叫中国</p>-->
    </div>
   <div class="card">
     <!--分享出去的页面要显示 名片-->
     <div class="c_card main" id="c_card">
       <div class="img"><img id="user_photo" src="./images/photo.jpg" alt=""></div>
       <div class="info">
         <span id="cn_name"></span> (<span id="en_name"></span>)
       </div>
       <div class="eweima"><img src="" alt=""></div>
     </div>
     <!--分享出去的页面要显示 名片 end-->
   </div>
  </div>
  <!--名片 end-->
  <!--素材列表-->
  <div class="sourceBox">
    <!--自定义文字-->
    <div class="sourceZDTxt">
      <div class="main">
        <div class="tit">编辑文字 <div class="close"><img src="./images/close.png" alt=""></div></div>
        <div class="textarea">
          <textarea name="" id="textarea" placeholder="请输入文字内容"></textarea>
        </div>
        <div class="btn"><span id="addTxt">确定</span></div>
      </div>
    </div>
    <!--自定义文字 end-->
    <div class="sourceTab main">
      <div class="item active" data-type="1">
        <div class="img"><img style="width: 20px; height: auto;" src="./images/zd_icon1.png" alt=""><img style="width: 20px; height: auto;" src="./images/zd_icon1r.png" alt=""></div>
        <div class="txt">换底图</div>
      </div>
      <div class="item" data-type="2">
        <div class="img"><img style="width: 15px; height: auto;" src="./images/zd_icon2.png" alt=""><img style="width: 15px; height: auto;" src="./images/zd_icon2r.png" alt=""></div>
        <div class="txt">名人名言</div>
      </div>
    </div>
    <div class="sourceCont">
      <!--底图-->
      <ul class="sourceImgs main">
        <li class="add" data-type="1">
          <label for="file">
          <img src="./images/zd_add.png" alt="">
            <input type="file" id="file" accept="image/*" style="display: none;">
          </label>
        </li>
        <li><img src="./images/bg1.jpg" alt=""></li>
        <li><img src="./images/bg2.jpg" alt=""></li>
        <li><img src="./images/bg6.jpg" alt=""></li>
        <li><img src="./images/bg7.jpg" alt=""></li>
        <li><img src="./images/bg1.jpg" alt=""></li>
        <li><img src="./images/bg2.jpg" alt=""></li>
        <li><img src="./images/bg6.jpg" alt=""></li>
        <li><img src="./images/bg7.jpg" alt=""></li>
      </ul>
      <!--底图 end-->
      <!--文字-->
      <div class="sourceText main none">
        <div class="sourceStyleTab">
          <span class="tab active" data-type="1">白色</span>
          <span class="tab" data-type="2">黑色</span>
          <span class="edit">自己写</span>
        </div>
        <ul class="sourceTextList">
          <li data-type="1">不选择名人名言</li>
          <li>只有经历过地狱般的磨砺，才能练就创造天堂的力量；只有流过血的手指，才能弹出世间的绝响。</li>
          <li>你以为挑起生活的担子是勇气，其实去过自己真正想要的生活才更需要勇气。</li>
          <li>没有目的，就做不成任何事情；目的渺小，就做不成任何大事</li>
          <li>生活就像海洋，只有意志坚强的人，才能到达彼岸。</li>
          <li>未曾失败的人恐怕也未曾成功过</li>
          <li>在这个并非尽善尽美的世界上，勤奋会得到报偿，而游手好闲则要受到惩罚.</li>
          <li>锲而舍之，朽木不折；锲而不舍，金石可镂。</li>
          <li>有些梦想，纵使永远也没办法实现，纵使光是连说出来都很奢侈。但如果没有说出来温暖自己一下，就无法获得前进的动力。</li>
        </ul>
      </div>
      <!--文字 end-->
    </div>
    <div class="sourceBot">
      <div class="main oh">
        <div class="btn"><span id="skan">预览</span></div>
        <div class="btn"><span id="product">生成</span></div>
      </div>
    </div>
  </div>
  <!--素材列表 end-->
  <!--预览弹出框-->
  <div class="skanBox">
    <div class="center">
      <div class="close"><img src="./images/close.png" alt=""></div>
      <img id="skanImg" src="./images/bg1.jpg" alt="">
    </div>
    <div class="sharebtn"><span>分享</span></div>
  </div>
  <!--预览弹出框 end-->
</div>
<div id="clipArea"><img id="clipAreaImg" src="./images/bg1.jpg" alt=""></div>
<div id="clipBtn">完成</div>
<script src="js/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/cropper/3.0.0/cropper.min.js"></script>
<script src="js/html2canvas.min.js"></script>
<script src="./js/exif.js"></script>
<script src="js/js.js"></script>
<script>
//  获取农历日期
getDateYin();
function getDateYin(){
  //农历
  var CalendarData=new Array(100);
  var madd=new Array(12);
  var tgString="甲乙丙丁戊己庚辛壬癸";
  var dzString="子丑寅卯辰巳午未申酉戌亥";
  var numString="一二三四五六七八九十";
  var monString="正二三四五六七八九十冬腊";
  var weekString="日一二三四五六";
  var sx="鼠牛虎兔龙蛇马羊猴鸡狗猪";
  var cYear,cMonth,cDay,TheDate;
  CalendarData = new Array(0xA4B,0x5164B,0x6A5,0x6D4,0x415B5,0x2B6,0x957,0x2092F,0x497,0x60C96,0xD4A,0xEA5,0x50DA9,0x5AD,0x2B6,0x3126E, 0x92E,0x7192D,0xC95,0xD4A,0x61B4A,0xB55,0x56A,0x4155B, 0x25D,0x92D,0x2192B,0xA95,0x71695,0x6CA,0xB55,0x50AB5,0x4DA,0xA5B,0x30A57,0x52B,0x8152A,0xE95,0x6AA,0x615AA,0xAB5,0x4B6,0x414AE,0xA57,0x526,0x31D26,0xD95,0x70B55,0x56A,0x96D,0x5095D,0x4AD,0xA4D,0x41A4D,0xD25,0x81AA5,0xB54,0xB6A,0x612DA,0x95B,0x49B,0x41497,0xA4B,0xA164B, 0x6A5,0x6D4,0x615B4,0xAB6,0x957,0x5092F,0x497,0x64B, 0x30D4A,0xEA5,0x80D65,0x5AC,0xAB6,0x5126D,0x92E,0xC96,0x41A95,0xD4A,0xDA5,0x20B55,0x56A,0x7155B,0x25D,0x92D,0x5192B,0xA95,0xB4A,0x416AA,0xAD5,0x90AB5,0x4BA,0xA5B, 0x60A57,0x52B,0xA93,0x40E95);
  madd[0]=0;
  madd[1]=31;
  madd[2]=59;
  madd[3]=90;
  madd[4]=120;
  madd[5]=151;
  madd[6]=181;
  madd[7]=212;
  madd[8]=243;
  madd[9]=273;
  madd[10]=304;
  madd[11]=334;

  function GetBit(m,n){
    return (m>>n)&1;
  }
  function e2c(){
    TheDate= (arguments.length!=3) ? new Date() : new Date(arguments[0],arguments[1],arguments[2]);
    var total,m,n,k;
    var isEnd=false;
    var tmp=TheDate.getYear();
    if(tmp<1900){
      tmp+=1900;
    }
    total=(tmp-1921)*365+Math.floor((tmp-1921)/4)+madd[TheDate.getMonth()]+TheDate.getDate()-38;

    if(TheDate.getYear()%4==0&&TheDate.getMonth()>1) {
      total++;
    }
    for(m=0;;m++){
      k=(CalendarData[m]<0xfff)?11:12;
      for(n=k;n>=0;n--){
        if(total<=29+GetBit(CalendarData[m],n)){
          isEnd=true; break;
        }
        total=total-29-GetBit(CalendarData[m],n);
      }
      if(isEnd) break;
    }
    cYear=1921 + m;
    cMonth=k-n+1;
    cDay=total;
    if(k==12){
      if(cMonth==Math.floor(CalendarData[m]/0x10000)+1){
        cMonth=1-cMonth;
      }
      if(cMonth>Math.floor(CalendarData[m]/0x10000)+1){
        cMonth--;
      }
    }
  }

  function GetcDateString(){
    var tmp="";
    // 什么年
    /** tmp+=tgString.charAt((cYear-4)%10);
     tmp+=dzString.charAt((cYear-4)%12);
     tmp+="(";
     tmp+=sx.charAt((cYear-4)%12);
     tmp+=")年 ";*/

    // 月份-日
    if(cMonth<1){
      tmp+="(闰)";
      tmp+=monString.charAt(-cMonth-1);
    }else{
      tmp+=monString.charAt(cMonth-1);
    }
    tmp+="月";
    tmp+=(cDay<11)?"初":((cDay<20)?"十":((cDay<30)?"廿":"三十"));
    if (cDay%10!=0||cDay==10){
      tmp+=numString.charAt((cDay-1)%10);
    }
    return tmp;
  }

  function GetLunarDay(solarYear,solarMonth,solarDay){
    //solarYear = solarYear<1900?(1900+solarYear):solarYear;
    if(solarYear<1921 || solarYear>2020){
      return "";
    }else{
      solarMonth = (parseInt(solarMonth)>0) ? (solarMonth-1) : 11;
      e2c(solarYear,solarMonth,solarDay);
      return GetcDateString();
    }
  }


  //农历
  var date = new Date();
  var yy=date.getFullYear();
  var mm=date.getMonth()+1;
  var dd=date.getDate();
  if (yy<100) yy="19"+yy;

  console.log(yy);
  var yindate = GetLunarDay(yy,mm,dd);
  $(".customizeCardDemo .month").text(yindate);
  $(".customizeCardDemo .year").text(yy+"年"+mm+"月");
  $(".customizeCardDemo .day").text(dd);
}

// 切换素材
  $(".sourceTab .item").click(function(){
    $(this).addClass("active").siblings().removeClass("active");
    var type = $(this).data("type");
    if(type == 1){
      $(".sourceText").hide();
      $(".sourceImgs").show();
    }else if(type == 2){
      $(".sourceImgs").hide();
      $(".sourceText").show();
    }
  });

  // 换背景图
  $(".sourceImgs").on("click","li",function(){
    var type = $(this).data("type");
    if(!type){
      var src = $(this).find("img").attr("src");
      $(".customizeCardDemo .cover img").attr("src",src);
      // 由于图片域名和当前域名不是同一域名，存在跨域问题，所以需要把图片转化为base64
      getImgBase64(src);
    }
  });

  var Orientation = null;
  // 本地图片上传
  $("#file").on("change",function () {
    imgisbase64 = true;
    var file = this.files[0];
    var reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = function(e) {
      var newUrl = e.target.result;
      $(".customizeCardDemo .cover img").attr("src",newUrl);
//      $("#clipAreaImg").attr("src",newUrl);
//      $('#clipAreaImg').cropper('reset');
      // 切换组件并重新渲染方法
      $('#clipAreaImg').cropper('replace',newUrl,false);
      $("#clipArea").show();
      $("#clipBtn").show();
    };

  });


  // 文字切换
  $(".sourceStyleTab .tab").click(function(){
    $(this).addClass("active").siblings(".tab").removeClass("active");
    var type = $(this).data("type");
    if(type == 1){
      $(".customizeCardDemo").removeClass("black");
    }else if(type == 2){
      $(".customizeCardDemo").addClass("black");
    }
  });


  // 自定义文字
  $(".edit").click(function(){
    $(".sourceZDTxt").show();
    $(".sourceBot").hide();

  });

  $(".sourceZDTxt .close").click(function(){
    $(".sourceZDTxt").hide();
    $(".sourceBot").show();
  });
  // 切换文字
  $(".sourceTextList").on("click","li",function(){
    $(this).addClass("active").siblings("li").removeClass("active");
    var dtype = $(this).data("type");
    if(!dtype){
      var txt = $(this).text();
      var narr=[];
      if(txt.length<=14){
        narr[0]=txt;
      }else{
        var reg=/.{14}/g;
        narr=txt.match(reg);//注意如果txt的长度小于10,那么res=null
        narr.push(txt.substring(narr.join('').length));
      }
      var str = '';
      $.each(narr,function(i,v){
        str += '<p>'+v+'</p>';
      });
      $(".slogan").html(str);
      $(".slogan").show();
    }else{
      $(".slogan").hide();
    }
  });

  // 添加文字
  $("#addTxt").click(function(){
    var txt = $("#textarea").val();
    var narr=[];
    if(txt){
      if(txt.length<14){
        narr[0]=txt;
      }else{
        var reg=/.{14}/g;
        narr=txt.match(reg);//注意如果txt的长度小于10,那么res=null
        narr.push(txt.substring(narr.join('').length));
      }
      var str = '';
      $.each(narr,function(i,v){
        str += '<p>'+v+'</p>';
      });
      $(".slogan").html(str);
    }
    $("#textarea").val("");
    $(".sourceZDTxt").hide();
    $(".sourceBot").show();
  });


  var imgisbase64 = false; // 判断当前图片是不是base64 不是的话有跨域问题要转化一下才行
  // 预览
  $("#skan").click(function(){
    if(!imgisbase64){
      c_ts("图片转换中，请稍后重试");
      return false;
    }
    document.getElementById("loading_wrap_box").style.background = 'none';
    document.getElementById("loading_wrap_box").style.opacity = 1;
    document.getElementById("loading_wrap_box").style.visibility = 'visible';
    html2canvas($(".customizeCardDemo")[0], {
      scale:2,
      logging:false,
      useCORS:true
    }).then(function(canvas) {
      console.log(canvas);
      var dataUrl = canvas.toDataURL();
      console.log(dataUrl);
      $("#skanImg").attr("src",dataUrl);
      $(".sharebtn").hide();
      $(".skanBox").show();
      document.getElementById("loading_wrap_box").style.opacity = 0;
      document.getElementById("loading_wrap_box").style.visibility = 'hidden';
    });
  });
  // 生成图片
  $("#product").click(function(){
    if(!imgisbase64){
      c_ts("图片转换中，请稍后重试");
      return false;
    }
    document.getElementById("loading_wrap_box").style.background = 'none';
    document.getElementById("loading_wrap_box").style.opacity = 1;
    document.getElementById("loading_wrap_box").style.visibility = 'visible';
    html2canvas($(".customizeCardDemo")[0], {
      scale:2,
      logging:false,
      useCORS:true,
      dpi: window.devicePixelRatio
    }).then(function(canvas) {
      console.log(canvas);
      var dataUrl = canvas.toDataURL();
      console.log(dataUrl);
      $("#skanImg").attr("src",dataUrl);
      $(".sharebtn").show();
      $(".skanBox").show();

      // 将base64格式图片 转为Blob，然后上传到后台
      dataURLtoBlob(dataUrl);
      function dataURLtoBlob(dataurl) {
        var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
          bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        var blogData = new Blob([u8arr], { type: mime });
        console.log("blogData");
        console.log(blogData);
        var param = new FormData();
        param.append("img", blogData,"123.jpg");
        uploadImg(param);
      }
    });
  });
  $(".skanBox .close").click(function(){
    $(".skanBox").hide();
  });

  var shareImgId = null;
  var shareImgSrc = null;
  // 上传图片
  function uploadImg(data) {
    console.log(data);
    // 上传图片
    $.ajax({
      url: HOST+'/api2/cloud_team/upload_img',
      type: 'post',
      processData: false,
      contentType: false,
      data: data,
      success: function (res) {
        res = JSON.parse(res);
        if(res.code == 0){
          console.log(res.data.id);
          console.log(res.data.url);
          shareImgId = res.data.id;
          shareImgSrc = res.data.url;
          document.getElementById("loading_wrap_box").style.opacity = 0;
          document.getElementById("loading_wrap_box").style.visibility = 'hidden';
        }
      },
      error: function (err) {
        console.log(err);
      }
    })
  }


$('#clipAreaImg').cropper({
  aspectRatio: 26 / 38, // 设置切图比例
  dragMode: 'move',//拖拽模式
  viewMode:1,
  crop: function (e) {
    console.log(e);
  }
});

$("#clipBtn").on("click", function () {
  var cas=$('#clipAreaImg').cropper('getCroppedCanvas');
  var base64url=cas.toDataURL('image/jpeg');
  $(".customizeCardDemo .cover img").attr("src",base64url);
  $("#clipArea").hide();
  $("#clipBtn").hide();

})
</script>
</body>
</html>